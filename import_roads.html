<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Import Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #2c5f2d; }
        .progress {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: #2c5f2d;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .status {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin: 15px 0;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            background: #2c5f2d;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        button:hover { background: #4a7c59; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat { text-align: center; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #2c5f2d; }
        .stat-label { color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Road Import Tool</h1>
        <p>This tool imports road data from OpenStreetMap into Supabase for the Canvassing Planner.</p>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="total-roads">-</div>
                <div class="stat-label">Roads to Import</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="imported-roads">0</div>
                <div class="stat-label">Imported</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="failed-roads">0</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>

        <div class="progress">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>

        <div>
            <button id="btn-fetch" onclick="fetchRoads()">1. Fetch Roads from OSM</button>
            <button id="btn-import" onclick="importRoads()" disabled>2. Import to Supabase</button>
            <button id="btn-clear" onclick="clearRoads()">Clear All Roads</button>
        </div>

        <div class="status" id="status">Ready. Click "Fetch Roads" to start.</div>
    </div>

    <script>
        const SUPABASE_URL = 'https://jwbjrgpcwwqrumstaqfi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3YmpyZ3Bjd3dxcnVtc3RhcWZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MDM2MDUsImV4cCI6MjA3OTQ3OTYwNX0.ZaN62Uhe09uheuzoLT1NWv4otrH0TI5XnKaDNwAFUUk';
        const OVERPASS_URL = 'https://overpass-api.de/api/interpreter';

        let roads = [];
        let imported = 0;
        let failed = 0;

        function log(msg) {
            const status = document.getElementById('status');
            status.innerHTML = msg + '<br>' + status.innerHTML;
            console.log(msg);
        }

        function updateProgress(current, total) {
            const pct = Math.round((current / total) * 100);
            const bar = document.getElementById('progress-bar');
            bar.style.width = pct + '%';
            bar.textContent = pct + '%';
        }

        async function fetchRoads() {
            document.getElementById('btn-fetch').disabled = true;
            log('Fetching roads from OpenStreetMap for Birchanger & Stansted...');

            const query = `[out:json][timeout:120];
area["name"="Birchanger"]["boundary"="administrative"]->.birchanger;
area["name"="Stansted Mountfitchet"]["boundary"="administrative"]->.stansted;
(
  way["highway"~"^(primary|secondary|tertiary|residential|unclassified|living_street|service)$"](area.birchanger);
  way["highway"~"^(primary|secondary|tertiary|residential|unclassified|living_street|service)$"](area.stansted);
);
out body;
>;
out skel qt;`;

            try {
                const response = await fetch(OVERPASS_URL, {
                    method: 'POST',
                    body: 'data=' + encodeURIComponent(query),
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });

                if (!response.ok) throw new Error('Overpass API error: ' + response.status);

                const data = await response.json();
                const elements = data.elements || [];

                // Process nodes and ways
                const nodes = {};
                const ways = [];

                elements.forEach(el => {
                    if (el.type === 'node') {
                        nodes[el.id] = { lat: el.lat, lng: el.lon };
                    } else if (el.type === 'way') {
                        ways.push(el);
                    }
                });

                log(`Found ${ways.length} road segments, ${Object.keys(nodes).length} nodes`);

                // Convert to road objects
                roads = [];

                ways.forEach(way => {
                    const tags = way.tags || {};
                    const highway = tags.highway || 'road';
                    // Generate name for unnamed roads
                    const name = tags.name || tags.ref || `Unnamed ${highway.replace('_', ' ')}`;

                    const coords = [];
                    (way.nodes || []).forEach(nodeId => {
                        if (nodes[nodeId]) {
                            coords.push([nodes[nodeId].lng, nodes[nodeId].lat]);
                        }
                    });

                    if (coords.length < 2) return;

                    roads.push({
                        id: 'osm_' + way.id,
                        name: name,
                        geojson: {
                            type: 'Feature',
                            properties: { name, highway, osm_id: way.id },
                            geometry: { type: 'LineString', coordinates: coords }
                        },
                        status: 'none'
                    });
                });

                document.getElementById('total-roads').textContent = roads.length;
                log(`Processed ${roads.length} valid roads`);
                document.getElementById('btn-import').disabled = false;

            } catch (error) {
                log('Error: ' + error.message);
                document.getElementById('btn-fetch').disabled = false;
            }
        }

        async function importRoads() {
            if (roads.length === 0) {
                log('No roads to import. Fetch roads first.');
                return;
            }

            document.getElementById('btn-import').disabled = true;
            imported = 0;
            failed = 0;

            log(`Starting import of ${roads.length} roads...`);

            const batchSize = 50;
            const total = roads.length;

            for (let i = 0; i < roads.length; i += batchSize) {
                const batch = roads.slice(i, i + batchSize);

                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/roads`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'resolution=merge-duplicates'
                        },
                        body: JSON.stringify(batch)
                    });

                    if (response.ok) {
                        imported += batch.length;
                    } else {
                        const errorText = await response.text();
                        log(`Batch error (${response.status}): ${errorText.substring(0, 100)}`);
                        failed += batch.length;
                    }
                } catch (error) {
                    log(`Network error: ${error.message}`);
                    failed += batch.length;
                }

                document.getElementById('imported-roads').textContent = imported;
                document.getElementById('failed-roads').textContent = failed;
                updateProgress(i + batch.length, total);

                // Small delay between batches
                await new Promise(r => setTimeout(r, 100));
            }

            log(`Import complete! ${imported} imported, ${failed} failed.`);
            updateProgress(total, total);
        }

        async function clearRoads() {
            if (!confirm('Are you sure you want to delete ALL roads from the database?')) return;

            log('Clearing all roads...');

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/roads?id=neq.null`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (response.ok) {
                    log('All roads cleared.');
                    document.getElementById('imported-roads').textContent = '0';
                } else {
                    log('Error clearing roads: ' + response.status);
                }
            } catch (error) {
                log('Error: ' + error.message);
            }
        }

        // Check current count on load
        async function checkCount() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/roads?select=id`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'count=exact'
                    }
                });

                if (response.ok) {
                    const range = response.headers.get('content-range');
                    if (range) {
                        const count = range.split('/')[1];
                        log(`Current roads in database: ${count}`);
                    }
                } else {
                    log(`API status: ${response.status} - ${await response.text()}`);
                }
            } catch (error) {
                log('Could not check database: ' + error.message);
            }
        }

        checkCount();
    </script>
</body>
</html>
